<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>2옥타브 웹 피아노</title>
<style>
  body { font-family:sans-serif; padding:20px; }
  #piano { display:flex; position:relative; }
  .white {
    width:60px; height:220px;
    background:white; border:1px solid #555;
    margin:1px; box-sizing:border-box;
    position:relative;
    text-align:center; line-height:200px;
    cursor:pointer; border-radius:4px;
  }
  .white.active { background:#cfe3ff; }
  .black {
    width:40px; height:140px;
    background:black; color:white;
    position:absolute; top:0; z-index:2;
    border-radius:4px;
    text-align:center; line-height:120px;
    cursor:pointer;
  }
  .black.active { background:#444; }
</style>
</head>
<body>

<h2>2옥타브 브라우저 피아노 (Shift = 반음)</h2>
<p>⚠️ 처음 사용할 때 화면을 한 번 클릭해야 소리가 활성화됩니다.</p>

<div id="piano"></div>

<script>
/* ---------------------------
   오디오 초기화
---------------------------- */
const AudioContext = window.AudioContext || window.webkitAudioContext;
const ctx = new AudioContext();
let unlocked = false;
function unlock() {
  if (!unlocked) {
    ctx.resume();
    unlocked = true;
  }
}
document.body.addEventListener("click", unlock);

/* ---------------------------
   음계 설정
   C4(60) ~ B5(83)  → 총 24음
---------------------------- */
function midiToFreq(m) {
  return 440 * Math.pow(2, (m - 69) / 12);
}
function playNote(midi) {
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.type = "sine";
  osc.frequency.value = midiToFreq(midi);
  osc.connect(gain);
  gain.connect(ctx.destination);

  gain.gain.setValueAtTime(0.001, ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.8, ctx.currentTime + 0.02);
  gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.4);

  osc.start();
  osc.stop(ctx.currentTime + 0.45);
}

/* ---------------------------
   키 매핑
---------------------------- */
// 흰 건반 (24개)
const whiteKeys = [
  "z","x","c","v","b","n","m",",",".","/","a","s","d","f","g","h","j","k","l",";","'"
];

// C4~B5 : MIDI 60~83 중 흰건반만 추출
const whiteMidi = [
  60,62,64,65,67,69,71, // Z~/
  72,74,76,77,79,81,83  // A~'
];

// 검은 건반 (#) → 5개씩 x 2옥타브 = 10개
// 1~0 - = 키들 매핑
const blackKeys = ["1","2","3","4","5","6","7","8","9","0","-","="];

// C#4~A#5 (총 10개)
const blackMidi = [
  61,63,66,68,70, // 1~5
  73,75,78,80,82  // 6~0
];

/* ---------------------------
   UI 건반 생성
---------------------------- */

const piano = document.getElementById("piano");

// 흰건반 생성
whiteMidi.forEach((midi,i)=>{
  const key = document.createElement("div");
  key.className = "white";
  key.dataset.key = whiteKeys[i] || "";
  key.dataset.midi = midi;
  key.textContent = (whiteKeys[i]||"").toUpperCase();
  piano.appendChild(key);
});

// 검은건반 위치 계산 (흰건반 사이)
const whiteEls = document.querySelectorAll(".white");
const blackOffsets = [0,1,3,4,5]; // C#,D#,F#,G#,A#

let blackIndex = 0;
for (let oct=0; oct<2; oct++) {
  blackOffsets.forEach(offset=>{
    const idx = offset + oct*7;
    const white = whiteEls[idx];
    if (!white) return;

    const b = document.createElement("div");
    b.className = "black";
    b.dataset.key = blackKeys[blackIndex] || "";
    b.dataset.midi = blackMidi[blackIndex];
    b.textContent = blackKeys[blackIndex].toUpperCase();

    // 위치 설정
    b.style.left = (white.offsetLeft + 40) + "px";

    piano.appendChild(b);
    blackIndex++;
  });
}

/* ---------------------------
   이벤트: 마우스
---------------------------- */

function pressKey(el, shiftMode=false) {
  unlock();
  let midi = Number(el.dataset.midi);
  if (shiftMode) midi += 1;   // Shift로 반음 증가
  playNote(midi);
  el.classList.add("active");
  setTimeout(()=>el.classList.remove("active"),150);
}

piano.addEventListener("mousedown", e=>{
  const key = e.target.closest(".white, .black");
  if(!key) return;
  pressKey(key, e.shiftKey);
});

/* ---------------------------
   이벤트: 키보드
---------------------------- */

function findElement(key) {
  return [...document.querySelectorAll(".white,.black")]
    .find(el=>el.dataset.key === key);
}

window.addEventListener("keydown", e=>{
  if (e.repeat) return;
  const k = e.key.toLowerCase();
  const el = findElement(k);
  if (!el) return;
  pressKey(el, e.shiftKey);
});
</script>

</body>
</html>
